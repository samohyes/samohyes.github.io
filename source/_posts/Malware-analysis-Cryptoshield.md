---
title: 'Malware analysis: Cryptoshield'
date: 2018-01-07 22:34:21
tags:
- 2018
- Malware analysis
- Windows malware
---
This is actually the first malware that I analyzed totally on my own. And yeah, the process is quite interesting. You can get the malware here.

http://www.malware-traffic-analysis.net/2017/01/31/index2.html

So first, I tried to unpack it and extracted the payload. I opened the malware in Ollydbg and let it break on every new dll. So I just ran it until two new sections shows up. If we click on it, we can see it’s the PE file format.

{% asset_img 3.PNG %}  

Save the payload and open it in IDA. 

{% asset_img 4.PNG %} 

At the beginning, we see these two functions <b><i>sub_402A10</i></b> and <b><i>sub_402980</i></b>. 

The first function gets the volume serial number. If we go into it, we can see it iterates from ‘A’ to ‘Z’ and when it comes to ‘C’, the <b><i>GetVolumeInformation</i></b> API successfully gets the serial number of ‘C’ volume so it breaks out the loop. In my system, the serial number for my ‘C’ volume is <b><i>EC4EBD1D</i></b>. For the second function, it uses <b><i>GetUserName</i></b> API and then calculates a number. Look at this.
 
{% asset_img 5.PNG %} 

Yeah, I analyzed it and we can see the algorithm is like this: multiply every character by 128 and add the next character. So I get <b><i>1CF0ED</i></b> with the user name ‘sam’. 

So after these two functions, we can see two APIs <b><i>CreateMutex</i></b> and <b><i>WaitForSingleObject</i></b>. They are used to make sure only one virus is running on the victim’s machine. And we can see that, it uses <b><i>Wsprintf</i></b> to link the two numbers we got from those two functions together to be the mutex’s name. Then we come to here.

{% asset_img 6.PNG %} 

So at the function <b><i>sub_403180</i></b>, it wants to create a file <b><i>C://Users/sam/AppData/Roaming/1FAAXB2.tmp</i></b> but failed. After that, it came to <b><i>sub_4024D0</i></b>. This is actually the function that it stays persistence. It copy the payload and set the registry key to run every time the system boots. Check it out here.
 
{% asset_img 14.PNG %} 

Ok, let’s move on.
 
{% asset_img 10.PNG %} 

The function I highlighted here is the actual encryption. Double click it.
 
{% asset_img 11.PNG %} 

The malware checks the type of our drive. The ‘C’ volume is DRIVE_FIXED. And if we use sharefold in the virtualbox, it might be DRVIVE_REMOTE, it will be encrypted too. So after it checks the drive’s type, it starts encryption. The actually process is long, so let’s just look at some key points here.

{% asset_img 12.PNG %}  

We can see the encryption APIs here. 

{% asset_img 8.PNG %} 

This is where the encryption begins. We can see the plaintext there. 

{% asset_img 9.PNG %} 

The content changes after the encryption.

To make the whole process clear, I draw a picture.

{% asset_img 13.PNG %} 

Yeah, this’s the whole process. 

Any question, please contact me at <b><i>xudong_shao@hotmail.com</i></b>