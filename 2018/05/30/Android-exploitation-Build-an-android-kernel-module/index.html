<!DOCTYPE html>
<html lang="">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="Android exploitation: Build an android kernel module"/>




  <meta name="keywords" content="Android,2018," />





  <link rel="alternate" href="/default" title="秋水">




  <link rel="shortcut icon" type="image/x-icon" href="/1.jpg?v=1.1" />



<link rel="canonical" href="http://samohyes.github.io/2018/05/30/Android-exploitation-Build-an-android-kernel-module/"/>


<meta name="description" content="Creating android kernel module in emulator is really painful. So here I want to show you how to create a loadable module. My environment:Ubuntu 18.04Android 4.4">
<meta name="keywords" content="Android,2018">
<meta property="og:type" content="article">
<meta property="og:title" content="Android exploitation: Build an android kernel module">
<meta property="og:url" content="http://samohyes.github.io/2018/05/30/Android-exploitation-Build-an-android-kernel-module/index.html">
<meta property="og:site_name" content="秋水">
<meta property="og:description" content="Creating android kernel module in emulator is really painful. So here I want to show you how to create a loadable module. My environment:Ubuntu 18.04Android 4.4.2Goldfish 3.4 Most the configuration is">
<meta property="og:image" content="http://samohyes.github.io/2018/05/30/Android-exploitation-Build-an-android-kernel-module/1.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/05/30/Android-exploitation-Build-an-android-kernel-module/2.PNG">
<meta property="og:updated_time" content="2018-11-28T22:57:14.232Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android exploitation: Build an android kernel module">
<meta name="twitter:description" content="Creating android kernel module in emulator is really painful. So here I want to show you how to create a loadable module. My environment:Ubuntu 18.04Android 4.4.2Goldfish 3.4 Most the configuration is">
<meta name="twitter:image" content="http://samohyes.github.io/2018/05/30/Android-exploitation-Build-an-android-kernel-module/1.PNG">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> Android exploitation: Build an android kernel module - 秋水 </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">秋水</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>

      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Android exploitation: Build an android kernel module
        
      </h1>

      <time class="post-time">
          May 30 2018
      </time>
    </header>



    
            <div class="post-content">
            <p>Creating android kernel module in emulator is really painful. So here I want to show you how to create a loadable module.</p>
<p>My environment:<br>Ubuntu 18.04<br>Android 4.4.2<br>Goldfish 3.4</p>
<p>Most the configuration is the same with my previous post here:<br><a href="http://xdshao.com/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/" target="_blank" rel="noopener">http://xdshao.com/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/</a><br>And if you read this post before you read mine, it will be a really big help.<br><a href="https://abdullahyousafzaii.wordpress.com/2015/08/02/how-to-write-a-kernel-module-for-android/" target="_blank" rel="noopener">https://abdullahyousafzaii.wordpress.com/2015/08/02/how-to-write-a-kernel-module-for-android/</a><br>But if you only follow his paper, you will fail with my environment.</p>
<p>I also created a video here. If you prefer to watch videos, it will be a good choice.</p>
<div class="video-container"><iframe src="//www.youtube.com/embed/HZQDxRVxeBg" frameborder="0" allowfullscreen></iframe></div>
<p>So before we start, there are several things we need to do.</p>
<p>First, go to the goldfish/arch/arm/configs/goldfish_armv7_defconfig file and add these lines at the end.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_MODULES=y</span><br><span class="line">CONFIG_MODULE_FORCE_LOAD=y</span><br><span class="line">CONFIG_MODULE_UNLOAD=y</span><br><span class="line">CONFIG_MODULE_FORCE_UNLOAD=y</span><br></pre></td></tr></table></figure>
<p>Also, if you just add these lines and start compile the kernel, you will get a lot of errors. So you will want to delete these configurations. Simply add “#” before the line.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#CONFIG_NF_CONNTRACK_IPV6=y</span></span><br><span class="line"><span class="comment">#CONFIG_IP6_NF_IPTABLES=y</span></span><br><span class="line"><span class="comment">#CONFIG_IP6_NF_FILTER=y</span></span><br><span class="line"><span class="comment">#CONFIG_IP6_NF_TARGET_REJECT=y</span></span><br><span class="line"><span class="comment">#CONFIG_IP6_NF_TARGET_REJECT_SKERR=y</span></span><br><span class="line"><span class="comment">#CONFIG_IP6_NF_MANGLE=y</span></span><br><span class="line"><span class="comment">#CONFIG_IP6_NF_RAW=y</span></span><br><span class="line"><span class="comment">#CONFIG_NETFILTER_XT_MATCH_QTAGUID=y</span></span><br></pre></td></tr></table></figure>
<p>To make it better, add this at the beginning.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CONFIG_IPV6 is not set</span></span><br></pre></td></tr></table></figure>
<p>When you finish these things, you are done with the environment. Go to the goldfish/drivers and create a directory. Let’s make it <b>“helloworld”</b>. To make it clear, you can create this directory anywhere you want. But here we make it in the drivers directory.<br>Under the <b>“helloworld”</b>, you need to create several files.<br>The first one is hello.c. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"Xudong Shao 2018"</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">"Hello World Kernel Module for Android"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">"Hello Kernel World....\n"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hello_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">"Goodbye Kernel World\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br></pre></td></tr></table></figure>
<p>The second one is Makefile.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">obj-m   := hello.o</span><br><span class="line"></span><br><span class="line">KERNEL_DIR = ~/Documents/kernel/goldfish</span><br><span class="line"></span><br><span class="line">all:</span><br><span class="line">        make -C $(KERNEL_DIR) M=$(PWD)/ ARCH=arm CROSS_COMPILE=$(CROSS_COMPILE) modules</span><br></pre></td></tr></table></figure>
<p>Then all you need to do is type “make” in the terminal in this directory. And you will get several files here. What you need is the “hello.ko”. Start the emulator now.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emulator -show-kernel -kernel arch/arm/boot/zImage -avd kernelEXP -no-boot-anim -no-skin -no-audio -no-window -qemu -monitor unix:/tmp/qemuSocket,server,nowait -s</span><br></pre></td></tr></table></figure>
<p>Push the “hello.ko” to the /data/local/tmp. Then insert the module and remove it. You will see this.<br><img src="/2018/05/30/Android-exploitation-Build-an-android-kernel-module/1.PNG"></p>
<p>Let’s take a look at the second one. This kind of kernel module is built into the kernel so it will get loaded when you start the kernel and no need to load it manually.</p>
<p>Same here. Go to the goldfish/drivers directory and create the “helloword” directory. In this case, you have to make it here because we need to change the “Kconfig” and “Makefile” under the “drivers” directory.</p>
<p>First, in this “helloworld” directory, create “hello.c”.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"Xudong Shao 2018"</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">"Hello World Kernel Module for Android"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">"Hello Kernel World....\n"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hello_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">"Goodbye Kernel World\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br></pre></td></tr></table></figure>
<p>The second one is Kconfig.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">config HELLO_MOD</span><br><span class="line">	tristate <span class="string">"Hello World Module"</span></span><br><span class="line">	default y</span><br><span class="line">	depends on MODULES</span><br><span class="line">	<span class="built_in">help</span></span><br><span class="line">	  This module will write Hello Kernel World to the Kernel Message Buffer</span><br></pre></td></tr></table></figure>
<p>The third one is “Makefile”.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">obj-y   := hello.o</span><br><span class="line"></span><br><span class="line">KERNEL_DIR = ~/Documents/kernel/goldfish</span><br><span class="line"></span><br><span class="line">all:</span><br><span class="line">        make -C $(KERNEL_DIR) M=$(PWD)/ ARCH=arm CROSS_COMPILE=$(CROSS_COMPILE) modules</span><br></pre></td></tr></table></figure>
<p>Then go to the “Kconfig” under the “drivers” directory and add this:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">“<span class="built_in">source</span> drivers/helloworld/Kconfig”</span><br></pre></td></tr></table></figure>
<p>Go to the “Makefile” under the “drivers” directory and add this:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">“obj-y    += helloworld/”</span><br></pre></td></tr></table></figure>
<p>After you finish all these things, go to the goldfish directory and do this to compile the whole kernel.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make goldfish_armv7_defconfig &amp;&amp; make -j8</span><br></pre></td></tr></table></figure>
<p>Now you get the new kernel, start it. Check this:</p>
<img src="/2018/05/30/Android-exploitation-Build-an-android-kernel-module/2.PNG">
<p>The module is loaded automatically!</p>
<p>Finally, we make it here! To be honest, in order to figure out how to set those configuration files, it took me several days. I asked many people and it just didn’t work on my machine. So be patient and move on.</p>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/Android/">Android</a>
		  
			<a href="/tags/2018/">2018</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2018/06/03/Android-exploitation-kernel-out-of-array-index/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Android exploitation: kernel out of array index</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2018/04/23/Android-exploitation-exported-activities/">
        <span class="next-text nav-default">Android exploitation: exported activities</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2014 -
    
    2018
    <span class="footer-author">秋水.</span>

    <span class="post-meta-divider">|</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
