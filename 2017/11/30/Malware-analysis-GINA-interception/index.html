<!DOCTYPE html>
<html lang="">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="Malware analysis: GINA interception(PMA-11-01)"/>




  <meta name="keywords" content="2017,Malware analysis,Windows malware," />





  <link rel="alternate" href="/default" title="Xudong">




  <link rel="shortcut icon" type="image/x-icon" href="/1.jpg?v=1.1" />



<link rel="canonical" href="http://samohyes.github.io/2017/11/30/Malware-analysis-GINA-interception/"/>


<meta name="description" content="This malware is from Practical Malware Analysis Lab 11-1. I will start from this book and probably include some malwares from other sources in the future. Stati">
<meta name="keywords" content="2017,Malware analysis,Windows malware">
<meta property="og:type" content="article">
<meta property="og:title" content="Malware analysis: GINA interception(PMA-11-01)">
<meta property="og:url" content="http://samohyes.github.io/2017/11/30/Malware-analysis-GINA-interception/index.html">
<meta property="og:site_name" content="Xudong">
<meta property="og:description" content="This malware is from Practical Malware Analysis Lab 11-1. I will start from this book and probably include some malwares from other sources in the future. Static analysisI always start from basic stat">
<meta property="og:image" content="http://samohyes.github.io/2017/11/30/Malware-analysis-GINA-interception/1.png">
<meta property="og:image" content="http://samohyes.github.io/2017/11/30/Malware-analysis-GINA-interception/2.png">
<meta property="og:image" content="http://samohyes.github.io/2017/11/30/Malware-analysis-GINA-interception/3.png">
<meta property="og:image" content="http://samohyes.github.io/2017/11/30/Malware-analysis-GINA-interception/4.png">
<meta property="og:updated_time" content="2017-12-28T15:49:42.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Malware analysis: GINA interception(PMA-11-01)">
<meta name="twitter:description" content="This malware is from Practical Malware Analysis Lab 11-1. I will start from this book and probably include some malwares from other sources in the future. Static analysisI always start from basic stat">
<meta name="twitter:image" content="http://samohyes.github.io/2017/11/30/Malware-analysis-GINA-interception/1.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> Malware analysis: GINA interception(PMA-11-01) - Xudong </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">Xudong</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>

      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Malware analysis: GINA interception(PMA-11-01)
        
      </h1>

      <time class="post-time">
          Nov 30 2017
      </time>
    </header>



    
            <div class="post-content">
            <p>This malware is from <b><i>Practical Malware Analysis</i></b> Lab 11-1. I will start from this book and probably include some malwares from other sources in the future.</p>
<p></p><h3><b><u>Static analysis</u></b></h3><br>I always start from basic static analysis and this is probably what most people will do. PEID shows this file has no packer. So we just start analysis straightforward. Since we know nothing about this malware right now. I simply use the string.exe in the SysinternalSuite to find useful clues. After applying this, I see some interesting strings in the .exe file.<p></p>
<p>&#149; Software\Microsoft\Windows NT\CurrentVersion\Winlogon<br>&#149;    Msgina.dll<br>&#149;    Many functions with Wlx prefix</p>
<p>This result makes me believe this malware sample is likely doing GINA interception. What is GINA interception? GINA means Graphical Identification and Authentication. This allows third-party customizing the logon process. So likely malwares can take advantage of this process. Basically, GINA works like this: winlogon.exe call the msgina.dll. And what third parties can do is to insert a .dll between the winlogon.exe and the msgina.dll which looks like this:</p>
<p>Winlogon.exe &#8594; malicious.dll &#8594; msgina.dll</p>
<p>So in this case, we can see that malicious.dll should can get the password from winlogon.exe. But it also has to make sure that it exports those functions needed by msgina.dll and most of these functions has prefix of Wlx. Also in order to let winlogon.exe call the malicious.dll it has to change a value in registry which is the first string that we are interested in.</p>
<p>After this, I’d love to use the dependency worker and CFF to see what’s in this file. This is what we got from the dependency worker.</p>
<img src="/2017/11/30/Malware-analysis-GINA-interception/1.png" title="this is it">
<p>We find that the file imports KERNEL32.DLL and ADVAPI32.DLL. In KERNEL32.DLL, there are CreateFile and WriteFile. Also I use CFF and find there is a .rsrc section whose virtual size is much bigger than raw size. Combining these two clues, I think it probably will drop a file. And we also see the ADVAPI32.DLL which changed the registry that we mentioned before. After this, it’s time for us to start dynamic analysis.</p>
<p></p><h3><b><u>Dynamic analysis</u></b></h3><br>I will start regshot and Process Monitor right now. And after double clicking the malware we can see that there is a msgina32.dll in the same directory which should be the man-in-the-middle .dll in the GINA interception attack.<p></p>
<p>Also we see there is a change to<br><b><i>HKLM\Software\Microsoft\WindowsNT\CurrentVersion\Winlogon\GinaDLL</i></b><br>from regshot. So we go to this registry key and find its value is <b><i>C:\msgina.dll</i></b> which is the directory for that malicious .dll the file dropped. This is how it achieves GINA interception.</p>
<p>From Process Monitor, we didn’t find anything it create except the msgina.dll. So probably it will create a file after the system reboots and writes the login information into that file.</p>
<p></p><h3><b><u>Advanced analysis</u></b></h3><br>Let’s load the msgina32.dll into ida. We will see this branch in the DLLmain function.<p></p>
<img src="/2017/11/30/Malware-analysis-GINA-interception/2.png">
<p>The left side is the function to load the original msgina.dll. We can see the code mov hModule,eax here which is used to indicate which function that msgina32.dll is going to call from the msgina.dll to make sure that the whole login process is fine. You can check that in the export functions of msgina32.dll it uses this to get the address of the functions in the msgina.dll.</p>
<p>So what the malicious can do is to change the export functions. Which means that it can do something before it call the function in the msgina.dll. After searching for a while, we find the export function <b>WlxloggedoutSAS</b> is suspicious because it contains more things than others.</p>
<img src="/2017/11/30/Malware-analysis-GINA-interception/3.png">
<p>Let’s click the sub_1ooo1570, we finally see how the .dll save the login information.</p>
<img src="/2017/11/30/Malware-analysis-GINA-interception/4.png">
<p>Here is the <b>“msutil32.sys”</b> which seems like a driver file but it is just used to save information. This is located at <b><i>C:\Windows\system32</i></b> where the logon.exe is. </p>
<p>So you can just logout and login on windows so you will see that the password is in the file right now.</p>
<p>So we are nearly done with this malicious binary. You can do more if you want. </p>
<p>Any questions, you can contact me at<br><b><i>xudong_shao@hotmail.com</i></b></p>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/2017/">2017</a>
		  
			<a href="/tags/Malware-analysis/">Malware analysis</a>
		  
			<a href="/tags/Windows-malware/">Windows malware</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2017/12/02/Malware-analysis-Inline-hooking-PMA-11-02/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Malware analysis: Inline hooking(PMA-11-02)</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2014 -
    
    2018
    <span class="footer-author">Xudong.</span>
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <span id="busuanzi_container_site_pv">Total visits:<span id="busuanzi_value_site_pv"></span></span>
    <span class="post-meta-divider">|</span>
    <span class="power-by">
        由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a> 强力驱动
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
