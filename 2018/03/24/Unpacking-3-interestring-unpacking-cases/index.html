<!DOCTYPE html>
<html lang="">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="Unpacking: 3 interesting unpacking cases"/>




  <meta name="keywords" content="2018,Unpacking," />





  <link rel="alternate" href="/default" title="Xudong">




  <link rel="shortcut icon" type="image/x-icon" href="/1.jpg?v=1.1" />



<link rel="canonical" href="http://samohyes.github.io/2018/03/24/Unpacking-3-interestring-unpacking-cases/"/>


<meta name="description" content="I want to introduce some interesting unpacking cases that I encountered these days. And you can find some video tutorials for these from MalwareAnalysisForHedge">
<meta name="keywords" content="2018,Unpacking">
<meta property="og:type" content="article">
<meta property="og:title" content="Unpacking: 3 interesting unpacking cases">
<meta property="og:url" content="http://samohyes.github.io/2018/03/24/Unpacking-3-interestring-unpacking-cases/index.html">
<meta property="og:site_name" content="Xudong">
<meta property="og:description" content="I want to introduce some interesting unpacking cases that I encountered these days. And you can find some video tutorials for these from MalwareAnalysisForHedgehogs and hasherezade on youtbe. Case 1 T">
<meta property="og:image" content="http://samohyes.github.io/2018/03/24/Unpacking-3-interestring-unpacking-cases/1.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/03/24/Unpacking-3-interestring-unpacking-cases/2.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/03/24/Unpacking-3-interestring-unpacking-cases/3.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/03/24/Unpacking-3-interestring-unpacking-cases/4.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/03/24/Unpacking-3-interestring-unpacking-cases/5.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/03/24/Unpacking-3-interestring-unpacking-cases/6.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/03/24/Unpacking-3-interestring-unpacking-cases/7.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/03/24/Unpacking-3-interestring-unpacking-cases/8.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/03/24/Unpacking-3-interestring-unpacking-cases/9.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/03/24/Unpacking-3-interestring-unpacking-cases/10.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/03/24/Unpacking-3-interestring-unpacking-cases/11.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/03/24/Unpacking-3-interestring-unpacking-cases/12.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/03/24/Unpacking-3-interestring-unpacking-cases/13.PNG">
<meta property="og:updated_time" content="2018-03-25T07:16:50.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Unpacking: 3 interesting unpacking cases">
<meta name="twitter:description" content="I want to introduce some interesting unpacking cases that I encountered these days. And you can find some video tutorials for these from MalwareAnalysisForHedgehogs and hasherezade on youtbe. Case 1 T">
<meta name="twitter:image" content="http://samohyes.github.io/2018/03/24/Unpacking-3-interestring-unpacking-cases/1.PNG">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> Unpacking: 3 interesting unpacking cases - Xudong </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">Xudong</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>

      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Unpacking: 3 interesting unpacking cases
        
      </h1>

      <time class="post-time">
          Mar 24 2018
      </time>
    </header>



    
            <div class="post-content">
            <p>I want to introduce some interesting unpacking cases that I encountered these days. And you can find some video tutorials for these from MalwareAnalysisForHedgehogs and hasherezade on youtbe.</p>
<p><b><i>Case 1</i></b></p>
<p>TOOLS: python, HxD<br>Sample: <a href="https://www.hybrid-analysis.com/sample/a6cbeeecfb50bf94499547fbf0adc6451326be45a16462f9056eaba2342fcf2c?environmentId=100" target="_blank" rel="noopener">https://www.hybrid-analysis.com/sample/a6cbeeecfb50bf94499547fbf0adc6451326be45a16462f9056eaba2342fcf2c?environmentId=100</a></p>
<p>We know some packing techniques are that they use a key to ‘XOR’ with the original PE file so and embed it into a new one. In this case, we can see that if we know the key we can easily unpack it. This is the method we are going to use.</p>
<p>Firstly, open the file in the HxD.</p>
<img src="/2018/03/24/Unpacking-3-interestring-unpacking-cases/1.PNG">
<p>We can see the repeating string <b><i>”W..1..4..3..5..8…..”</i></b>. For now, we will try this string as the key to see what we get. And the reason why we think the original PE file starts at the highlighted place is that the second byte in the key is 0 and “Z XOR 0 is Z” so that might be the start of MZ. So copy from that part.</p>
<img src="/2018/03/24/Unpacking-3-interestring-unpacking-cases/2.PNG">
<p>Then we will write a python script to unpack the payload.</p>
<img src="/2018/03/24/Unpacking-3-interestring-unpacking-cases/3.PNG">
<p>After running our code, we have our payload now.</p>
<img src="/2018/03/24/Unpacking-3-interestring-unpacking-cases/4.PNG"> 
<p><b><i>Case 2</i></b></p>
<p>TOOLS: PE-sieve<br>Sample: <a href="https://www.hybrid-analysis.com/sample/008c4bd6ee834d113cfc693af0ea90396eaa47e860bcdd567ffd964b57434e1d?environmentId=100" target="_blank" rel="noopener">https://www.hybrid-analysis.com/sample/008c4bd6ee834d113cfc693af0ea90396eaa47e860bcdd567ffd964b57434e1d?environmentId=100</a></p>
<p>Basically, pe-sieve is a tool developed by hasherezade and it can actually dump the PE file in the memory. And it can deal with some custom packers. But for this sample, it is not that easy.</p>
<p>Run the sample and get the PID. Then use the pe-sieve to dump the payload.</p>
<img src="/2018/03/24/Unpacking-3-interestring-unpacking-cases/5.PNG">
<p>But if we open the exe and dll file we get in pe-studio we may find out that they are not the payload. And the exe file seems having another loader. So run that file again. Suspend it. Open the OllyDbg and attach to the new process.</p>
<img src="/2018/03/24/Unpacking-3-interestring-unpacking-cases/6.PNG">
<p>And check the memory you will find there is a very interesting section.</p>
<img src="/2018/03/24/Unpacking-3-interestring-unpacking-cases/7.PNG">
<p>This section seems like a PE file without the MZ and PE magic number. Because we can see all those section names there. So what we are going to do is to add the magic number to the file.</p>
<img src="/2018/03/24/Unpacking-3-interestring-unpacking-cases/8.PNG">
<p>Then the pe-sieve can dump the payload. You need to use the command “pe-sieve PID /imp” to automatically recovery the import directory.</p>
<img src="/2018/03/24/Unpacking-3-interestring-unpacking-cases/9.PNG">
<p>And we can see that the payload starting at 220000 has been successfully dumped and there are many suspicious APIs.</p>
<p><b><i>Case 3</i></b></p>
<p>TOOLS: OD<br>Sample: <a href="https://www.hybrid-analysis.com/sample/482a8b7ead1e07ac728e1e2b9bcf90a26af9b98b15969a3786834d6e81d393cd?environmentId=100" target="_blank" rel="noopener">https://www.hybrid-analysis.com/sample/482a8b7ead1e07ac728e1e2b9bcf90a26af9b98b15969a3786834d6e81d393cd?environmentId=100</a></p>
<p>We know sometimes some scripts are wrapped in the .exe file. For this sample, it is a wrapped .bat file. You can also use DIE to check it.</p>
<img src="/2018/03/24/Unpacking-3-interestring-unpacking-cases/10.PNG"> 
<p>For this one, the key point is to set a breakpoint on <b><i>WriteFile</i></b>. Because the malware will finally write the payload into the disk.</p>
<img src="/2018/03/24/Unpacking-3-interestring-unpacking-cases/11.PNG">
<p>Copy this part using a hex editor. </p>
<img src="/2018/03/24/Unpacking-3-interestring-unpacking-cases/12.PNG"> 
<p>Then you can change the extension to .bat and check the payload.</p>
<img src="/2018/03/24/Unpacking-3-interestring-unpacking-cases/13.PNG"> 

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/2018/">2018</a>
		  
			<a href="/tags/Unpacking/">Unpacking</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Android exploitation: Kernel stack buffer overflow</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2018/03/11/Unpacking-Delete-the-reloc-section/">
        <span class="next-text nav-default">Unpacking: Delete the .reloc section</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2014 -
    
    2018
    <span class="footer-author">Xudong.</span>
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <span id="busuanzi_container_site_pv">Total visits:<span id="busuanzi_value_site_pv"></span></span>
    <span class="post-meta-divider">|</span>
    <span class="power-by">
        由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a> 强力驱动
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
