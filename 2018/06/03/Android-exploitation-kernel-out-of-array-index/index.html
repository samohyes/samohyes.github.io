<!DOCTYPE html>
<html lang="">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="Android exploitation: kernel out of array index"/>




  <meta name="keywords" content="Android exploitation,2018," />





  <link rel="alternate" href="/default" title="Xudong">




  <link rel="shortcut icon" type="image/x-icon" href="/1.jpg?v=1.1" />



<link rel="canonical" href="http://samohyes.github.io/2018/06/03/Android-exploitation-kernel-out-of-array-index/"/>


<meta name="description" content="This time, I am going to show you an android kernel exploitation coming from not checking the array index. You can find the source code of the vulnerable driver">
<meta name="keywords" content="Android exploitation,2018">
<meta property="og:type" content="article">
<meta property="og:title" content="Android exploitation: kernel out of array index">
<meta property="og:url" content="http://samohyes.github.io/2018/06/03/Android-exploitation-kernel-out-of-array-index/index.html">
<meta property="og:site_name" content="Xudong">
<meta property="og:description" content="This time, I am going to show you an android kernel exploitation coming from not checking the array index. You can find the source code of the vulnerable driver and the way to set up the environment h">
<meta property="og:image" content="http://samohyes.github.io/2018/06/03/Android-exploitation-kernel-out-of-array-index/1.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/06/03/Android-exploitation-kernel-out-of-array-index/2.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/06/03/Android-exploitation-kernel-out-of-array-index/3.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/06/03/Android-exploitation-kernel-out-of-array-index/4.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/06/03/Android-exploitation-kernel-out-of-array-index/5.PNG">
<meta property="og:updated_time" content="2018-06-04T00:46:37.629Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android exploitation: kernel out of array index">
<meta name="twitter:description" content="This time, I am going to show you an android kernel exploitation coming from not checking the array index. You can find the source code of the vulnerable driver and the way to set up the environment h">
<meta name="twitter:image" content="http://samohyes.github.io/2018/06/03/Android-exploitation-kernel-out-of-array-index/1.PNG">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> Android exploitation: kernel out of array index - Xudong </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">Xudong</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>

      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Android exploitation: kernel out of array index
        
      </h1>

      <time class="post-time">
          Jun 03 2018
      </time>
    </header>



    
            <div class="post-content">
            <p>This time, I am going to show you an android kernel exploitation coming from not checking the array index. You can find the source code of the vulnerable driver and the way to set up the environment here.<br><a href="http://xdshao.com/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/" target="_blank" rel="noopener">http://xdshao.com/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/</a><br>Also, you can check my previous post about how to build the kernel module.</p>
<p>I’ve record a video here for those who prefer to watch videos.</p>
<div class="video-container"><iframe src="//www.youtube.com/embed/4N8f1A0N6Mc" frameborder="0" allowfullscreen></iframe></div>
<p>Ok, first let’s read the source code of the misc driver and find out how can we use it to gain the root shell.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">CommandHandler handlers[] = &#123;</span><br><span class="line">   &#123;</span><br><span class="line">     .runHandler = &amp;doNothingIntializer</span><br><span class="line">   &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     .runHandler = &amp;doNothingIntializer</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">ai_ch_ioctl</span><span class="params">(struct file *filp,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">int</span> handler_index = arg;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> RUN_COMMAND_HANDLER:</span><br><span class="line">       handlers[handler_index].runHandler();</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span> :</span><br><span class="line">       printk(<span class="string">"Unknown ioctl cmd: %d"</span>, cmd);</span><br><span class="line">       <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>I don’t want to mention the misc driver here but you can find a ton of tutorials about it online. What we need to know here is that when we call</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handlers[handler_index].runHandler();</span><br></pre></td></tr></table></figure>
<p>The code doesn’t check the handler_index here. So if we give a big handler_index, it will point to somewhere else. And if we can control that place, we can let it execute the code we want. Take a look at this picture.</p>
<img src="/2018/06/03/Android-exploitation-kernel-out-of-array-index/1.PNG">
<p>The basic idea is this. If we input 0, it will call handles[0] which is the function at the 0xC00C1000. But if we call handler[4], it will call the function at 0xDEADBEEF.<br>Then, let’s take a look at the solution code.<br>In that code, we see the function get_symbol which will get the address of the function commit_creds and prepare_kernel_cred. The idea is that if we call commit_creds(prepare_kernel_cred) it will get the root id. And the main function is really simple. At first, we mmap a piece of memory and put the shellcode at the end of that part. And the data before the shellcode are zero which is nop. It means do nothing. So when we jump to that nop part, the shellcode will get executed at the end. This sounds really simple, right? But when we actually take an action, it’s much more difficult.</p>
<p>So, let’s make our hands dirty.</p>
<p>Before we start, I made a few changes to the driver source code to make our life easier. Take a look at this.</p>
<img src="/2018/06/03/Android-exploitation-kernel-out-of-array-index/2.PNG">
<p>This will print out the handlers[index] content. So we know where it points to and we can figure out the mmap base address. If we don’t do this, we have to try index starting from 0 until we find a reasonable address where we can mmap and execute the code. I tried to write a shell script to automatically get that index but failed. Because you have to mess up with those threading and subprocess stuff. It’s really annoying and it takes a long time. If you want to have a try, just go ahead.</p>
<p>So let’s start the emulator and insert the driver. We can see it prints out these address.</p>
<img src="/2018/06/03/Android-exploitation-kernel-out-of-array-index/3.PNG">
<p>You have to be careful here. In my machine, I can’t mmap around 0 or c0000000. The latter one is the starting address of the kernel. And you can’t choose the address like 72657a69. That’s because the last bit of the address is 1 and it will go to execute the thumb instruction. But our shell code is arm instruction. So you have to choose the even address. Here I choose the address 165. So my solution code looks like this.</p>
<img src="/2018/06/03/Android-exploitation-kernel-out-of-array-index/4.PNG">
<p>Before you compile you code using ndk. Please do this in adb shell. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">“chmod <span class="number">777</span> /dev/array_index”</span><br><span class="line">“echo <span class="number">0</span> &gt; /proc/sys/kernel/kptr_restrict”</span><br></pre></td></tr></table></figure>
<p>So you can write to the device as a normal user. I have to mention that it’s much more difficult to exploit in real word. Here as I just want to explain this vulnerability so we can do this to make our life easier.<br>At the end, run the binary and get the root shell.</p>
<img src="/2018/06/03/Android-exploitation-kernel-out-of-array-index/5.PNG">
            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/Android-exploitation/">Android exploitation</a>
		  
			<a href="/tags/2018/">2018</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2018/07/04/Qemu-source-user-mode-initialization-and-ioctls/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Qemu source: user mode initialization and ioctls</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2018/05/30/Android-exploitation-Build-an-android-kernel-module/">
        <span class="next-text nav-default">Android exploitation: Build an android kernel module</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2014 -
    
    2018
    <span class="footer-author">Xudong.</span>
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <span id="busuanzi_container_site_pv">Total visits:<span id="busuanzi_value_site_pv"></span> times</span>
    <span class="post-meta-divider">|</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
