---
title: 'Malware analysis: Gatak and code injection'
date: 2017-12-22 14:06:14
tags:
- 2017
- Malware analysis
- Windows malware
---

In this post, we are going to talk about code injection. This is mainly about allocating and inserting code into the memory space of a remote process. Some typical API calls are <b><i>“VirtualAllocEx”, ”WriteProcesMemory”, “CreateProcess”, ”CreateRemoteThread”.</i></b> These are the APIs that you want to set a breakpoint on.

Before we start, I have to mention that MalwareAnalysisForhedgehogs has already done a good video tutorial for what I am going to talk about. You can check it here.

So open that sample in x64dbg now. And set breakpoints on <b><i>“VirtualAllocEx”, ”WriteProcesMemory”, “CreateProcess”, ”CreateRemoteThread”</i></b> using <b><i>“CTRL+G”</i></b>. Then press F9 to run it.

{% asset_img 1.PNG %}

This is the first breakpoint at <b><i>“CreateProcess”</i></b>. You can see that it’s going to create the rundll32.exe process. And you can see that <b><i>“00000004”</i></b> which is the suspended flag in the <b><i>CreateProcess</i></b> API. press F9 again and come to here.

{% asset_img 2.PNG %}

This is the breakpoint in <b><i>“VirtualAllocEx”</i></b> and you can see that the <b><i>“rundll32.exe”</i></b> process has been created.Press F9 again. And it allocate some memory in <b><i>6D1F78</i></b>, you can keep an eye on it.

{% asset_img 3.PNG %}

Yeah. This is the breakpoint at <b><i>“WriteProcessMemory”</i></b>. You can see that in the memory of the sample there are some malicious code. Actually the address of the <b><i>rundll32.exe</i></b> that the sample going to write the codes are <b><i>0x90000</i></b>. So let’s use HxD to attach to the <b><i>rundll32.exe</i></b> and see what it has in that address.

{% asset_img 4.PNG %}

Yeah, that’s it. Nothing in this address in <b><i>rundll32.exe</i></b> before the sample call <b><i>“WriteProcessMemory”</i></b>. But now let’s come back to the x64dbg and press F9 again.

{% asset_img 5.PNG %}

This is the picture in the x64dbg. And while in the HxD, there is something.

{% asset_img 6.PNG %}

Yeah. That’s it. The malicious code actually written into that memory address in the rundll.exe! Now you can just dump it in the HxD.

When you came back to X64dbg and press F9 you will stop at this <b><i>“CreateProcess”</i></b> API which calls cmd to delete the file itself.

{% asset_img 7.PNG %}

Ok, that’s all. You can analyze that file you dumped in the IDA. Actually I tried and don’t know how to start analyze that due to the limitation of my knowledge. But I will keep learning and hoping one day I can succeed in analyzing those things!

Any question, please contact me at <b><i>xudong_shao@hotmail.com</i></b>
