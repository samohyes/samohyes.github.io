<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Xudong">
<meta property="og:url" content="http://samohyes.github.io/index.html">
<meta property="og:site_name" content="Xudong">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Xudong">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://samohyes.github.io/"/>





  <title> Hexo, NexT - Xudong </title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Xudong</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://samohyes.github.io/2017/12/20/Malware-analysis-Dridex-and-process-hollowing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xudong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xudong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/20/Malware-analysis-Dridex-and-process-hollowing/" itemprop="url">Malware analysis: Dridex and process hollowing</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-20T12:41:24-06:00">
                2017-12-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Well, to be honest, I didn’t make a lot progress on this malware and all those decoding process seems very complicated to me. But yeah, I will write down what I did and anyone who is looking this post should know that there is a better analysis here by MalwareAnalysisForHedgehogs. And they also provide a link to a good post to analysis this malware.</p>
<div class="video-container"><iframe src="//www.youtube.com/embed/aBKk2KAN0E0" frameborder="0" allowfullscreen></iframe></div>
<p>Basically, process hollowing create a new legitimate process and replace that process with malicious code. So the code may run as if it is legitimate. The key API should be <b><i>“CreateProcesS”</i></b>, <b><i>“WriteProcessMemory”</i></b>. What makes me confusing is here, the Dridex starts a child process and uses process hollowing to replace the content of that child process. I simply think this doesn’t make sense. Well, trevlix from this post <a href="https://www.reddit.com/r/Malware/comments/7kub4k/one_problem_i_faced_in_a_malware_can_anyone_help/" target="_blank" rel="noopener">here</a> told me that in this malware it probably use this to unpack itself. Probably he is right.</p>
<p>MalwareAnalysisForHedgehogs used APImonitor to set the breakpoint but I used Olldbg and it turns out that the blog they provide used Ollybdg too.</p>
<p>At first in Ollydbg, you need to set a breakpoint on <b><i>WriteProcessMemory</i></b> with <b><i>“bp WriteProcessMemory”</i></b>. Then you run it.</p>
<img src="/2017/12/20/Malware-analysis-Dridex-and-process-hollowing/1.png">
<p>You can check that buffer address here. You will see the start of a PE file. Then you have two choice. I used HxD tp attach to the process and go to the address <b><i>0x460000</i></b> then copied those thing into a new file. You can also just right click in the Ollydbg and save all those binary data. These will leads to the same file which is like this.</p>
<img src="/2017/12/20/Malware-analysis-Dridex-and-process-hollowing/2.png">
<p>Use the compare button in HxD we can verify that the files we get from two methods are the same.</p>
<p>Ok, this is all I have. Probably I will try to analyze this malware in details when I learn more.</p>
<p>Any questions, contact me at <b><i>xudong_shao@hotmail</i></b>.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://samohyes.github.io/2017/12/19/Crackme-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xudong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xudong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/19/Crackme-1/" itemprop="url">Crackme: 1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-19T19:56:06-06:00">
                2017-12-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>I’ve got more time during winter holiday so I will also do some crackme problems.</p>
<p>Today’s crackme problem is like this.</p>
<img src="/2017/12/19/Crackme-1/1.png">
<p>You need to input a name and a serial here. Try <b><i>“sam”</i></b> and <b><i>“123456”</i></b> you will fail let this.</p>
<img src="/2017/12/19/Crackme-1/2.png">
<p>OK, let’s open it in IDA. In the string subview you can find a string <b><i>“Good job dude=)”</i></b>. Double click it and you will come those important functions.<br>The first check is here.</p>
<img src="/2017/12/19/Crackme-1/3.png">
<p>It checks whether your name is longer than 3. Your name needs to have at least 4 characters. And in <b><i>0x42FA8A</i></b> you will find that you put the first character into eax and multiply it by 29H.</p>
<img src="/2017/12/19/Crackme-1/4.png">
<p>For “s” you will get 24D6.</p>
<p>And in <b><i>0x42FACD</i></b> you will find it generates the key.</p>
<img src="/2017/12/19/Crackme-1/5.png"> 
<p>Feel free to go into that function and see how it turn 24D6 into 9430. But actually it just change the hex value into decimal. Yeah, to be honest, I went into that function and spent a lot of time to analyze it and finally, I see that 24D6 and 9430 are the same number… This is sad.</p>
<p>Ok, so you will get the key which is <b><i>“CW”+ ”the key you generate”+ ”CRACKED”</i></b>.</p>
<p>Any question, please contact  me at <b><i>xudong_shao@hotmail.com</i></b></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://samohyes.github.io/2017/12/14/Unpacking-using-HxD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xudong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xudong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/14/Unpacking-using-HxD/" itemprop="url">Unpacking: using HxD</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-14T18:25:53-06:00">
                2017-12-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Today, let’s unpack a malware named <b><i>Fleercivet</i></b>. Before we start, I have to say that the <b><i>MalwareAnalysisForHegehogs</i></b> has already done a quite good video tutorial for this sample, you can check it out here.</p>
<div class="video-container"><iframe src="//www.youtube.com/embed/BCis7FwffiU" frameborder="0" allowfullscreen></iframe></div>
<p>So, let’t see how we can unpack it using a different way.</p>
<p>The first part is unpacking. In the video they did quite well using the breakpoint at <b><i>VirtualAlloc</i></b> and I also write a post on this method so you can check it out too.</p>
<p><a href="http://xdshao.com/2017/12/10/Unpacking-bp-VirtualAlloc/" target="_blank" rel="noopener">http://xdshao.com/2017/12/10/Unpacking-bp-VirtualAlloc/</a></p>
<p>But for this sample, you can see that the speaker used a plugin to dump the memory and unpack it. To be honest, I can’t find the plugin and the link they provide seems not working anymore. So here, I use another way to achieve the same purpose.</p>
<p>Let’s say you follow the video and come to this step where you see at the address 0X3A0000 you find “MZ” which is the start of the PE format. To be more specific, it’s the start of the DOS header.</p>
<img src="/2017/12/14/Unpacking-using-HxD/1.png">
<p>So you open the HxD and attach it to the process in the memory which is the sample name. And then you jump to the 0x3A0000.</p>
<img src="/2017/12/14/Unpacking-using-HxD/2.png">
<p>And you can also find that, the content is in the range of 0x3A0000 to 0x3D0FFF. Because there is some meaningless things starting at 0x3D1000.</p>
<img src="/2017/12/14/Unpacking-using-HxD/3.png">
<p>So all you need to do is to copy the content between 0x3A0000 and 0x3D0FFF to a new file then save it. You can use the     PortexAnalyzer.jar to check the SHA256 and it’s the same as that in the video.</p>
<img src="/2017/12/14/Unpacking-using-HxD/4.png">
<p>Any question, please contact me at xudong_shao@hotmail.com</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://samohyes.github.io/2017/12/10/Unpacking-bp-VirtualAlloc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xudong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xudong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/10/Unpacking-bp-VirtualAlloc/" itemprop="url">Unpacking: bp VirtualAlloc</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-10T21:28:14-06:00">
                2017-12-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>I decide to include some unpacking posts in my personal blog. So here it is.</p>
<p>VirtualAlloc is the api that malware use to allocate memory for the unpacking process so we can use it to unpack malware. I’ve found some tutorials for this strategy but they are not suitable for the sample here. You can check it yourself.</p>
<a href="http://paulslaboratory.blogspot.com/2014/04/unpacking-using-ollydbg.html" target="_blank" rel="noopener">unpacking-using-ollydbg</a>
<p>Here is a video using the same method to unpack a malware.<br><div class="video-container"><iframe src="//www.youtube.com/embed/BCis7FwffiU" frameborder="0" allowfullscreen></iframe></div></p>
<p>So this is the beginning of the unpacking.</p>
<img src="/2017/12/10/Unpacking-bp-VirtualAlloc/1.png">
<p>First, we input “bp VirtualAlloc” in the command input here.</p>
<img src="/2017/12/10/Unpacking-bp-VirtualAlloc/2.png">
<p>We can see now there is a breakpoint.</p>
<img src="/2017/12/10/Unpacking-bp-VirtualAlloc/3.png"> 
<p>Then you press F9 to run it. You come to here.</p>
<img src="/2017/12/10/Unpacking-bp-VirtualAlloc/4.png">
<p>Here is the code in DLL. Now you use “ALT+F9” to come back to the user code. Then you have to press F8 to continue going and you will finally find a “jmp” which lead you to the OEP.</p>
<img src="/2017/12/10/Unpacking-bp-VirtualAlloc/5.png">
<p>Actually, for this sample, using ESP should be much easier. But we can see even we are using the VirtualAlloc, there are still some difference for different samples. Those links that I provide can verify this. So always be patient when you are unpacking a malware.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://samohyes.github.io/2017/12/02/Malware-analysis-Inline-hooking-PMA-11-02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xudong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xudong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/02/Malware-analysis-Inline-hooking-PMA-11-02/" itemprop="url">Malware analysis: Inline hooking(PMA-11-02)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-02T21:32:32-06:00">
                2017-12-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Malware-analysis/" itemprop="url" rel="index">
                    <span itemprop="name">Malware analysis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>This sample is from <b><i>Practical Malware analysis</i></b> Lab 11-02. Mainly it’s doing inline hooking.</p>
<p></p><h3><b><u>Quick Background</u></b></h3><br>So let’s talk about inline hooking first. According to the PMA, inline hooking changes the actual function code. Basically, it replace the start of the code with a jump to the malicious code from the rootkit. After that, it will return back to the normal function to make sure everything goes well. PMA gives a good example for this. But I am pretty sure after reading this sample,  we will have a really deep understanding of inline hook.<p></p>
<p></p><h3><b><u>Static Analysis</u></b></h3><br>Let’s check our file first. The .ini file just contains a string which we don’t know what it means. You can probably assume it’s a password or something. But we can just head to the .dll now. Let’s use string.exe to check whether there are some interesting strings. We see some interesting ones:<p></p>
<p>&#149;   <b><i>SOFTWARE\Microsoft\Widows NT\CurrentVersion\Windows</i></b><br>&#149;   <b><i>AppInit_DLLs</i></b><br>This two must have something to do with the registry. Probably help the malware to stay persistence.<br>&#149;   <b><i>Spoolvxx32.dll</i></b><br>&#149;   <b><i>Send    wsock32.dll</i></b><br>This two might do something with internet.<br>&#149;   <b><i>Lab11-02.ini</i></b><br>It must do something with that mysterious string, right?<br>&#149;   <b><i>THEBAT.EXE OUTLOOK.EXE MSIMN.EXE</i></b><br>Might be some applications.</p>
<p>Ok, then we use CFF to see the PE structure.<br>We find that the .dll has an export function named installer. For the import directory we see that ReadFile, CreateFile. Not too much information here.</p>
<p></p><h3><b><u>Dynamic Analysis</u></b></h3><br>Let’s use the regshot and process monitor. Well, according to the regshot, we see there is a value modified:<br><b><i>HKLM\SOFTWARE\Microsoft\WidowsNT\CurrentVersion\Windows\AppInit_DLLs</i></b><p></p>
<p>And the value added is spoolvxx32.dll.Ok, this is how the malware manage to stay persistence. AppInit_DLLs will be loaded into every process that loads User32.dll. Normally, malware authors need to check the process name to determine they will run their payload. In this case, you probably will know that the string that we found, <b><i>“THEBAT.EXE OUTLOOK.EXE MSIMN.EXE”</i></b>, might be that check process. But if you don’t, no need to worry. To be honest, I didn’t figure it out when I am at this stage.</p>
<p>Then, what is the spoolvxx32? Ok, through Process monitor we can probably find something. We see this log:<br><b><i>CreateFile C:\Windows\system32\spoolvxx32.dll</i></b><br>So this is the one added to AppInit_DLL. We can use the winmd5 to examine the <b><i>spoolvxx32.dll</i></b> and the <b><i>Lab11-02.dll</i></b>. And it turns out they have the same md5 value.</p>
<p>Ok, until now, there are still something that we are not clear. We have this <b><i>“send wsock32.dll”</i></b> and <b><i>“THEBAT.EXE OUTLOOK.EXE MSIMN.EXE”</i></b>. We don’t know what is that doing. So let’s go to a more advanced analysis which will show us the inline hooking it does!</p>
<p></p><h3><b><u>Advanced analysis</u></b></h3><br>Let’s use the IDA to open that .dll file. At the DLLmain, we can see this branch.<p></p>
<img src="/2017/12/02/Malware-analysis-Inline-hooking-PMA-11-02/1.png">
<p>The code highlighted with yellow is the Getsystemdirectory call which will give us the system32 path. And we see that <b><i>‘strncat’</i></b> which add the <b><i>‘\lab11-02.dll’</i></b> to the system32 path. After that, it calls CreateFile. Actually, we have to make it clear that here CreateFile is not what we mean by create file. Here it’s creating an object in kernel which is more like open a file. This is something that really bothers me at first.</p>
<img src="/2017/12/02/Malware-analysis-Inline-hooking-PMA-11-02/2.png">
<p>After it opens the file, it just reads the string in the file and do something. There is a function here which is <b><i>sub_100010B3</i></b>, after we double click the function, we see some complicated code. But what I would assume is that it’s some kind of decoding function.</p>
<p>Let’s examine it in OllyDbg. But before doing this, make sure that we put the .ini file in the system directory. We see that the address for this call is 100016CA so  set a breakpoint at this address. And after we run the call we can see that in eax, there is a string which is an email address.</p>
<img src="/2017/12/02/Malware-analysis-Inline-hooking-PMA-11-02/3.png">
<p>Therefore, our assumption is right. The call is just a decoding function and you guys can try to reverse that function if you want.</p>
<p>Ok, now let’s go deeper. We see that after the readfile and closehandle, it calls <b><i>sub_100014B6</i></b>. This must the place that the malware actually do something. Double click it. We come to this place.</p>
<img src="/2017/12/02/Malware-analysis-Inline-hooking-PMA-11-02/4.png">
<p>First, there are two calls, <b><i>Sub_10001075</i></b> and <b><i>Sub_10001104</i></b>, which gets the process the name that the malicious dll attached to. So in our case, this should be <b><i>LOADDLL.EXE</i></b> because we are using the OllyDbg. So later, this malware checks whether the process name is any of <b><i>“THEBAT.EXE OUTLOOK.EXE MSIMN.EXE”</i></b>. If it’s any of this, it will jump to this piece of code.</p>
<img src="/2017/12/02/Malware-analysis-Inline-hooking-PMA-11-02/5.png">
<p>There are 3 calls here. For the <b><i>sub_100013BD</i></b>, if you dig deeper into it, you will find a function call for <b><i>suspendthread</i></b>. And for the <b><i>sub_10001499</i></b>, you will find a function call for <b><i>resumethread</i></b>. You can even dig much deeper to see how it suspend and resume the threads. But for now, we will stop here and turn to the call <b><i>sub_100012A3</i></b>.</p>
<p>And according to the four arguments that it pass in, we change the names of the variables at first which will show like this.</p>
<img src="/2017/12/02/Malware-analysis-Inline-hooking-PMA-11-02/6.png">
<p>This will definitely give you a lot convenience. In this piece of code, it mainly use the <b><i>GetProcessAddress</i></b> to get the address of send function. Then it goes to this piece of code.</p>
<img src="/2017/12/02/Malware-analysis-Inline-hooking-PMA-11-02/7.png">
<p>Oh,it finally pass in this send_address, it must be doing something real now!!! Otherwise, I will break down!!!</p>
<img src="/2017/12/02/Malware-analysis-Inline-hooking-PMA-11-02/8.png">
<p>Oh, what’s it doing here? No annotation at all! Don’t worry. We change the variable name to make it more clearly. It just calculate the difference between the address of <b><i>sub_1000113D</i></b> and the <b><i>send_address</i></b>. It then subtract it by 5 and move it into var_4. Here 5 is the size of the code of jump <em>*</em>. Then later it must add the opcode of the “jump” and the address of the hook function to the original send function. So let’s scroll down and find it.</p>
<img src="/2017/12/02/Malware-analysis-Inline-hooking-PMA-11-02/9.png">
<p>I use two rectangles to make it clear. How you can’t just change that 5 bytes, right? You must make sure that 5 bytes are still there when we later do something malicious and come back. So it can operate well otherwise it will break down and the victim will know he is attacked! So the malware must save that first 5 bytes somewhere. Before we come to that, we change the <b><i>var_8</i></b> to trampoline. This is what PMA did, because <b><i>var_8</i></b> stores the start of the code that solve the problem we just mentioned.</p>
<img src="/2017/12/02/Malware-analysis-Inline-hooking-PMA-11-02/10.png">
<p>Hi, hold on, dude. We are nearly done. Clearly, the first part is to set out a place for the trampoline function. The second part is to copy the first 5 bytes of send function into the trampoline. The third part is to pass the address if the trampoline into the variable <b><i>dword_10003484</i></b>. Ok, then let’s see the hook function which is at <b><i>1000113D</i></b>.</p>
<p>Actually what happens here is much easier. It just check whether there is the <b><i>“RCPT TO:”</i></b> in memory. If it’s there. it will add the email that we just find to the recipient list.</p>
<p>Ok, now, we are finalllllllllllllllly done!!!!!!!</p>
<p>Any question, please contact me at <b><i>xudong_shao@hotmail.com</i></b></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://samohyes.github.io/2017/11/30/Malware-analysis-GINA-interception/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xudong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xudong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/30/Malware-analysis-GINA-interception/" itemprop="url">Malware analysis: GINA interception(PMA-11-01)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-30T14:06:11-06:00">
                2017-11-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Malware-analysis/" itemprop="url" rel="index">
                    <span itemprop="name">Malware analysis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>This malware is from <b><i>Practical Malware Analysis</i></b> Lab 11-1. I will start from this book and probably include some malwares from other sources in the future.</p>
<p></p><h3><b><u>Static analysis</u></b></h3><br>I always start from basic static analysis and this is probably what most people will do. PEID shows this file has no packer. So we just start analysis straightforward. Since we know nothing about this malware right now. I simply use the string.exe in the SysinternalSuite to find useful clues. After applying this, I see some interesting strings in the .exe file.<p></p>
<p>&#149; Software\Microsoft\Windows NT\CurrentVersion\Winlogon<br>&#149;    Msgina.dll<br>&#149;    Many functions with Wlx prefix</p>
<p>This result makes me believe this malware sample is likely doing GINA interception. What is GINA interception? GINA means Graphical Identification and Authentication. This allows third-party customizing the logon process. So likely malwares can take advantage of this process. Basically, GINA works like this: winlogon.exe call the msgina.dll. And what third parties can do is to insert a .dll between the winlogon.exe and the msgina.dll which looks like this:</p>
<p>Winlogon.exe &#8594; malicious.dll &#8594; msgina.dll</p>
<p>So in this case, we can see that malicious.dll should can get the password from winlogon.exe. But it also has to make sure that it exports those functions needed by msgina.dll and most of these functions has prefix of Wlx. Also in order to let winlogon.exe call the malicious.dll it has to change a value in registry which is the first string that we are interested in.</p>
<p>After this, I’d love to use the dependency worker and CFF to see what’s in this file. This is what we got from the dependency worker.</p>
<img src="/2017/11/30/Malware-analysis-GINA-interception/1.png" title="this is it">
<p>We find that the file imports KERNEL32.DLL and ADVAPI32.DLL. In KERNEL32.DLL, there are CreateFile and WriteFile. Also I use CFF and find there is a .rsrc section whose virtual size is much bigger than raw size. Combining these two clues, I think it probably will drop a file. And we also see the ADVAPI32.DLL which changed the registry that we mentioned before. After this, it’s time for us to start dynamic analysis.</p>
<p></p><h3><b><u>Dynamic analysis</u></b></h3><br>I will start regshot and Process Monitor right now. And after double clicking the malware we can see that there is a msgina32.dll in the same directory which should be the man-in-the-middle .dll in the GINA interception attack.<p></p>
<p>Also we see there is a change to<br><b><i>HKLM\Software\Microsoft\WindowsNT\CurrentVersion\Winlogon\GinaDLL</i></b><br>from regshot. So we go to this registry key and find its value is <b><i>C:\msgina.dll</i></b> which is the directory for that malicious .dll the file dropped. This is how it achieves GINA interception.</p>
<p>From Process Monitor, we didn’t find anything it create except the msgina.dll. So probably it will create a file after the system reboots and writes the login information into that file.</p>
<p></p><h3><b><u>Advanced analysis</u></b></h3><br>Let’s load the msgina32.dll into ida. We will see this branch in the DLLmain function.<p></p>
<img src="/2017/11/30/Malware-analysis-GINA-interception/2.png">
<p>The left side is the function to load the original msgina.dll. We can see the code mov hModule,eax here which is used to indicate which function that msgina32.dll is going to call from the msgina.dll to make sure that the whole login process is fine. You can check that in the export functions of msgina32.dll it uses this to get the address of the functions in the msgina.dll.</p>
<p>So what the malicious can do is to change the export functions. Which means that it can do something before it call the function in the msgina.dll. After searching for a while, we find the export function <b>WlxloggedoutSAS</b> is suspicious because it contains more things than others.</p>
<img src="/2017/11/30/Malware-analysis-GINA-interception/3.png">
<p>Let’s click the sub_1ooo1570, we finally see how the .dll save the login information.</p>
<img src="/2017/11/30/Malware-analysis-GINA-interception/4.png">
<p>Here is the <b>“msutil32.sys”</b> which seems like a driver file but it is just used to save information. This is located at <b><i>C:\Windows\system32</i></b> where the logon.exe is. </p>
<p>So you can just logout and login on windows so you will see that the password is in the file right now.</p>
<p>So we are nearly done with this malicious binary. You can do more if you want. </p>
<p>Any questions, you can contact me at<br><b><i>xudong_shao@hotmail.com</i></b></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Xudong</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">Artikel</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">Kategorien</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">Tags</span>
                
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xudong</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
