<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="English">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Xudong">
<meta property="og:url" content="http://samohyes.github.io/index.html">
<meta property="og:site_name" content="Xudong">
<meta property="og:locale" content="English">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Xudong">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://samohyes.github.io/"/>





  <title> Hexo, NexT - Xudong </title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="English">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Xudong</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://samohyes.github.io/2017/11/30/Malware-analysis-GINA-interception/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xudong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xudong">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/30/Malware-analysis-GINA-interception/" itemprop="url">Malware analysis: GINA interception</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-30T14:06:11-06:00">
                2017-11-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>This malware is from <b><i>Practical Malware Analysis</i></b> Lab 11-1. I will start from this book and probably include some malwares from other sources in the future.</p>
<p></p><h3><b><u>Static analysis</u></b></h3><br>I always start from basic static analysis and this is probably what most people will do. PEID shows this file has no packer. So we just start analysis straightforward. Since we know nothing about this malware right now. I simply use the string.exe in the SysinternalSuite to find useful clues. After applying this, I see some interesting strings in the .exe file.<p></p>
<p>&#149; Software\Microsoft\Windows NT\CurrentVersion\Winlogon<br>&#149;    Msgina.dll<br>&#149;    Many functions with Wlx prefix</p>
<p>This result makes me believe this malware sample is likely doing GINA interception. What is GINA interception? GINA means Graphical Identification and Authentication. This allows third-party customizing the logon process. So likely malwares can take advantage of this process. Basically, GINA works like this: winlogon.exe call the msgina.dll. And what third parties can do is to insert a .dll between the winlogon.exe and the msgina.dll which looks like this:</p>
<p>Winlogon.exe &#8594; malicious.dll &#8594; msgina.dll</p>
<p>So in this case, we can see that malicious.dll should can get the password from winlogon.exe. But it also has to make sure that it exports those functions needed by msgina.dll and most of these functions has prefix of Wlx. Also in order to let winlogon.exe call the malicious.dll it has to change a value in registry which is the first string that we are interested in.</p>
<p>After this, I’d love to use the dependency worker and CFF to see what’s in this file. This is what we got from the dependency worker.</p>
<img src="/2017/11/30/Malware-analysis-GINA-interception/1.png" title="this is it">
<p>We find that the file imports KERNEL32.DLL and ADVAPI32.DLL. In KERNEL32.DLL, there are CreateFile and WriteFile. Also I use CFF and find there is a .rsrc section whose virtual size is much bigger than raw size. Combining these two clues, I think it probably will drop a file. And we also see the ADVAPI32.DLL which changed the registry that we mentioned before. After this, it’s time for us to start dynamic analysis.</p>
<p></p><h3><b><u>Dynamic analysis</u></b></h3><br>I will start regshot and Process Monitor right now. And after double clicking the malware we can see that there is a msgina32.dll in the same directory which should be the man-in-the-middle .dll in the GINA interception attack.<p></p>
<p>Also we see there is a change to<br><b><i>HKLM\Software\Microsoft\WindowsNT\CurrentVersion\Winlogon\GinaDLL</i></b><br>from regshot. So we go to this registry key and find its value is <b><i>C:\msgina.dll</i></b> which is the directory for that malicious .dll the file dropped. This is how it achieves GINA interception.</p>
<p>From Process Monitor, we didn’t find anything it create except the msgina.dll. So probably it will create a file after the system reboots and writes the login information into that file.</p>
<p></p><h3><b><u>Advanced analysis</u></b></h3><br>Let’s load the msgina32.dll into ida. We will see this branch in the DLLmain function.<p></p>
<img src="/2017/11/30/Malware-analysis-GINA-interception/2.png">
<p>The left side is the function to load the original msgina.dll. We can see the code mov hModule,eax here which is used to indicate which function that msgina32.dll is going to call from the msgina.dll to make sure that the whole login process is fine. You can check that in the export functions of msgina32.dll it uses this to get the address of the functions in the msgina.dll.</p>
<p>So what the malicious can do is to change the export functions. Which means that it can do something before it call the function in the msgina.dll. After searching for a while, we find the export function <b>WlxloggedoutSAS</b> is suspicious because it contains more things than others.</p>
<img src="/2017/11/30/Malware-analysis-GINA-interception/3.png">
<p>Let’s click the sub_1ooo1570, we finally see how the .dll save the login information.</p>
<img src="/2017/11/30/Malware-analysis-GINA-interception/4.png">
<p>Here is the <b>“msutil32.sys”</b> which seems like a driver file but it is just used to save information. This is located at <b><i>C:\Windows\system32</i></b> where the logon.exe is. </p>
<p>So you can just logout and login on windows so you will see that the password is in the file right now.</p>
<p>So we are nearly done with this malicious binary. You can do more if you want. </p>
<p>Any questions, you can contact me at<br><b><i>xudong_shao@hotmail.com</i></b></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Xudong</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xudong</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
