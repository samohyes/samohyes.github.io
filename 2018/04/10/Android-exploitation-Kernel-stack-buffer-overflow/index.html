<!DOCTYPE html>
<html lang="">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="Android exploitation: Kernel stack buffer overflow"/>




  <meta name="keywords" content="Android exploitation," />





  <link rel="alternate" href="/default" title="Xudong">




  <link rel="shortcut icon" type="image/x-icon" href="/1.jpg?v=1.1" />



<link rel="canonical" href="http://samohyes.github.io/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/"/>


<meta name="description" content="Frist, we are going to set up the environment for android kernel exploitation. And the tutorial can be found here.https://github.com/Fuzion24/AndroidKernelExplo">
<meta name="keywords" content="Android exploitation">
<meta property="og:type" content="article">
<meta property="og:title" content="Android exploitation: Kernel stack buffer overflow">
<meta property="og:url" content="http://samohyes.github.io/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/index.html">
<meta property="og:site_name" content="Xudong">
<meta property="og:description" content="Frist, we are going to set up the environment for android kernel exploitation. And the tutorial can be found here.https://github.com/Fuzion24/AndroidKernelExploitationPlaygroundBut there are some prob">
<meta property="og:image" content="http://samohyes.github.io/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/10.png">
<meta property="og:image" content="http://samohyes.github.io/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/5.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/2.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/6.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/7.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/8.PNG">
<meta property="og:image" content="http://samohyes.github.io/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/9.PNG">
<meta property="og:updated_time" content="2018-04-11T21:36:17.044Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android exploitation: Kernel stack buffer overflow">
<meta name="twitter:description" content="Frist, we are going to set up the environment for android kernel exploitation. And the tutorial can be found here.https://github.com/Fuzion24/AndroidKernelExploitationPlaygroundBut there are some prob">
<meta name="twitter:image" content="http://samohyes.github.io/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/10.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> Android exploitation: Kernel stack buffer overflow - Xudong </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">Xudong</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>

      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Android exploitation: Kernel stack buffer overflow
        
      </h1>

      <time class="post-time">
          Apr 10 2018
      </time>
    </header>



    
            <div class="post-content">
            <p>Frist, we are going to set up the environment for android kernel exploitation. And the tutorial can be found here.<br><a href="https://github.com/Fuzion24/AndroidKernelExploitationPlayground" target="_blank" rel="noopener">https://github.com/Fuzion24/AndroidKernelExploitationPlayground</a><br>But there are some problems with those instructions so I will provide what I did in this post. The OS I am using is Ubuntu 16.04.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install jdk</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.6</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> https://android.googlesource.com/kernel/goldfish</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/Fuzion24/AndroidKernelExploitationPlayground.git kernel_exploit_challenges</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> goldfish &amp;&amp; git checkout -t origin/android-goldfish-3.4 &amp;&amp; \</span><br><span class="line">git am --signoff &lt; ../kernel_exploit_challenges/kernel_build/debug_symbols_and_challenges.patch &amp;&amp; \</span><br><span class="line"><span class="built_in">cd</span> .. &amp;&amp; ln -s $(<span class="built_in">pwd</span>)/kernel_exploit_challenges/ goldfish/drivers/vulnerabilities</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=$(<span class="built_in">pwd</span>)/arm-linux-androideabi-4.6/bin/:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ARCH=arm SUBARCH=arm CROSS_COMPILE=arm-linux-androideabi- &amp;&amp;\</span><br><span class="line"><span class="built_in">export</span> PATH=$(<span class="built_in">pwd</span>)/arm-linux-androideabi-4.6/bin/:<span class="variable">$PATH</span> &amp;&amp; \</span><br><span class="line"><span class="built_in">cd</span> goldfish &amp;&amp; make goldfish_armv7_defconfig &amp;&amp; make -j8</span><br></pre></td></tr></table></figure>
<p>Download the sdk<br><a href="http://dl.google.com/android/android-sdk_r24.4.1-linux.tgz" target="_blank" rel="noopener">http://dl.google.com/android/android-sdk_r24.4.1-linux.tgz</a> </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar xvf android-sdk_r24.4.1-linux.tgz</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=$(<span class="built_in">pwd</span>)/android-sdk-linux/tools:<span class="variable">$PATH</span> </span><br><span class="line"><span class="built_in">export</span> PATH=$(<span class="built_in">pwd</span>)/arm-linux-androideabi-4.6/bin/:<span class="variable">$PATH</span></span><br><span class="line">(add these two to ~/.bashrc)</span><br><span class="line"></span><br><span class="line">android</span><br></pre></td></tr></table></figure>
<p>Then install these two.</p>
<img src="/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/10.png"> 
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">android create avd --force -t <span class="string">"android-19"</span> -n kernel_challenges</span><br><span class="line"></span><br><span class="line">(Go to the goldfish directory.)</span><br><span class="line">emulator -show-kernel -kernel arch/arm/boot/zImage -avd kernel_challenges -no-boot-anim -no-skin -no-audio -no-window -qemu -monitor unix:/tmp/qemuSocket,server,nowait -s</span><br><span class="line"></span><br><span class="line">sudo ln -s /usr/lib/x86_64-linux-gnu/libpython2.7.so.1.0 /usr/lib/x86_64-linux-gnu/libpython2.6.so.1.0</span><br></pre></td></tr></table></figure>
<p>Ok, let’s start the exploitation.</p>
<p>Take a look at the vulnerable module.</p>
<img src="/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/5.PNG"> 
<p>We can see that the copy_from_user functions actually copy the user input to the buffer. And this will cause the buffer overflow. So all we need to do is to manipulate the shellcode to get privilege. But what will our shellcode looks like? There should be 3 steps.</p>
<ol>
<li>Use commit_creds(prepare_kernel_cred(0)) to change into root user</li>
<li>Use mov R3,#0x40000010; MSR CPSR_c,R3; This can change from kernel mode into user mode. Because the function address of payload is in the user mode. So we need to go back to user mode so it can return to the payload function.</li>
<li>In the payload function, it will call /system/bin/sh so we can get a root shell.</li>
</ol>
<p>That’s all we need.<br>For the first step, we need to get the address of the prepare_kernel_cred and commit_creds. Start the emulator and use the adb to get a shell. But remember, before this you need to do “echo 0 &gt; /proc/sys/kernel/kptr_restric”. Otherwise, you can’t resolve the symbol for those functions in the kernel.</p>
<img src="/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/2.PNG"> 
<p>After this, you need to get the address of the payload.</p>
<img src="/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/6.PNG"> 
<p>Add a printf here so you will be able to see the address of the shellcode and payload.</p>
<img src="/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/7.PNG"> 
<p>Then, we are able to write the shellcode.</p>
<img src="/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/8.PNG"> 
<p>I think what the shellcode does here is quite obviously.<br>Use ndk-build to get the exp and you are able to get the root shell.<br><img src="/2018/04/10/Android-exploitation-Kernel-stack-buffer-overflow/9.PNG">  </p>
<p>The corresponding code will be in my github: samohyes.</p>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/Android-exploitation/">Android exploitation</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
    
      <a class="next" href="/2018/03/24/Unpacking-3-interestring-unpacking-cases/">
        <span class="next-text nav-default">Unpacking: 3 interesting unpacking cases</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2014 -
    
    2018
    <span class="footer-author">Xudong.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
